
# –ê—Å—Ç—Ä–æ–±–æ—Ç (Telegram, aiogram + PostgreSQL + LLM)

> MVP‚Äë–±–æ—Ç, –∫–æ—Ç–æ—Ä—ã–π —Å–æ–±–∏—Ä–∞–µ—Ç –¥–∞—Ç—É/–≤—Ä–µ–º—è/–º–µ—Å—Ç–æ —Ä–æ–∂–¥–µ–Ω–∏—è, —Å—Ç—Ä–æ–∏—Ç –∫–∞—Ä—Ç—É (—á–µ—Ä–µ–∑ –≤–Ω–µ—à–Ω–∏–π –∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä), –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç —Ä–∞–∑–±–æ—Ä—ã (LLM) –∏ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç **growth‚Äë–º–µ—Ö–∞–Ω–∏–∫–∏**: —Ä–µ—Ñ–µ—Ä–∞–ª–∫–∏ –∏ –¥–æ—Å—Ç—É–ø –ø–æ –ø–æ–¥–ø–∏—Å–∫–µ –Ω–∞ –∫–∞–Ω–∞–ª. –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –∏ —Ç–µ–∫—Å—Ç—ã —É–ø—Ä–∞–≤–ª—è—é—Ç—Å—è —á–µ—Ä–µ–∑ –ë–î/–∞–¥–º–∏–Ω–∫—É.

---

## ‚ú® –§—É–Ω–∫—Ü–∏–∏

- –û–Ω–±–æ—Ä–¥–∏–Ω–≥: –∏–º—è ‚Üí –ø–æ–ª ‚Üí —Å–∏—Å—Ç–µ–º–∞ –∞—Å—Ç—Ä–æ–ª–æ–≥–∏–∏ (–ó–∞–ø–∞–¥–Ω–∞—è/–í–µ–¥–∏—á–µ—Å–∫–∞—è/–ë–∞–¶–∑—ã) ‚Üí –¥–∞—Ç–∞/–≤—Ä–µ–º—è/–≥–æ—Ä–æ–¥.
- –ì–µ–æ–∫–æ–¥–∏–Ω–≥ –≥–æ—Ä–æ–¥–∞ ‚Üí –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –∏ —Ç–∞–π–º–∑–æ–Ω–∞; –ø–µ—Ä–µ–≤–æ–¥ –≤ UTC; —Ä–∞—Å—á—ë—Ç –∫–∞—Ä—Ç—ã (–≤–Ω–µ—à–Ω–∏–π –º–æ–¥—É–ª—å).
- –ü–µ—Ä–≤–∏—á–Ω—ã–π —Ä–∞–∑–±–æ—Ä –ø–æ—Å–ª–µ —Ä–∞—Å—á—ë—Ç–∞: **10 —Å–∏–ª—å–Ω—ã—Ö** –∏ **10 —Å–ª–∞–±—ã—Ö**.
- –†–∞–∑–¥–µ–ª—ã (—Å—Ü–µ–Ω–∞—Ä–∏–∏) –≥–ª–∞–≤–Ω–æ–≥–æ –º–µ–Ω—é:
  - `mission` ‚Äî –ú–∏—Å—Å–∏—è
  - `love` ‚Äî –õ–∏—á–Ω–∞—è –∂–∏–∑–Ω—å
  - `finance` ‚Äî –§–∏–Ω–∞–Ω—Å–æ–≤—ã–π –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª
  - `countries` ‚Äî –¢–æ–ø‚Äë5 —Å—Ç—Ä–∞–Ω –¥–ª—è –∂–∏–∑–Ω–∏
  - `business` ‚Äî –¢–æ–ø‚Äë10 –±–∏–∑–Ω–µ—Å‚Äë–∏–¥–µ–π
  - `karma` ‚Äî –ö–∞—Ä–º–∏—á–µ—Å–∫–∏–π —Ä–∞–∑–±–æ—Ä
  - `year` ‚Äî –ì–æ–¥–æ–≤–æ–π –æ—Ç—á—ë—Ç
- **–ö—ç—à + –≤–µ—Ä—Å–∏–∏** –æ—Ç–≤–µ—Ç–æ–≤: `session_facts` —Ö—Ä–∞–Ω–∏—Ç –¥–∞–Ω–Ω—ã–µ –∏ –∏—Å—Ç–æ—Ä–∏—é –≤–µ—Ä—Å–∏–π (`add_fact_version`).
- **–ì–µ–π—Ç—ã (–∑–∞–º–æ—á–∫–∏)** –Ω–∞ —Ä–∞–∑–¥–µ–ª—ã:
  - `referral` ‚Äî –æ—Ç–∫—Ä–æ–µ—Ç—Å—è –ø—Ä–∏ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–∏ –ø–æ—Ä–æ–≥–∞ –ø—Ä–∏–≥–ª–∞—à—ë–Ω–Ω—ã—Ö.
  - `channel` ‚Äî –æ—Ç–∫—Ä–æ–µ—Ç—Å—è –ø—Ä–∏ –ø–æ–¥–ø–∏—Å–∫–µ –Ω–∞ –∫–∞–Ω–∞–ª.
  - —á—Ç–æ –∏–º–µ–Ω–Ω–æ –∑–∞–∫—Ä—ã—Ç–æ ‚Äî –∑–∞–¥–∞—ë—Ç—Å—è **–¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏** –≤ `bonus_sections` (JSON) –≤ –∞–¥–º–∏–Ω–∫–µ.
- –†–µ—Ñ–µ—Ä–∞–ª—å–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞: deep‚Äëlink –≤–∏–¥–∞ `?start=ref<tg_id>`, —É—á—ë—Ç –ø—Ä–∏–≥–ª–∞—à—ë–Ω–Ω—ã—Ö –≤ —Ç–∞–±–ª–∏—Ü–µ `referrals`.
- –ü–æ–¥–¥–µ—Ä–∂–∫–∞ ¬´‚úÖ –Ø –ø–æ–¥–ø–∏—Å–∞–ª—Å—è¬ª (—É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–æ –¥–ª—è –ª—é–±–æ–≥–æ —Å—Ü–µ–Ω–∞—Ä–∏—è).

---

## üì¶ –°—Ç—Ä—É–∫—Ç—É—Ä–∞ (–æ—Å–Ω–æ–≤–Ω–æ–µ)

```
project/
‚îú‚îÄ bot/
‚îÇ  ‚îú‚îÄ handlers.py        # –æ—Å–Ω–æ–≤–Ω–æ–π —Ñ–ª–æ—É –∏ –º–µ–Ω—é, –≥–µ–π—Ç—ã, —Å—Ü–µ–Ω–∞—Ä–∏–∏
‚îÇ  ‚îú‚îÄ states.py          # FSM‚Äë—Å–æ—Å—Ç–æ—è–Ω–∏—è (Flow)
‚îÇ  ‚îú‚îÄ keyboards.py       # Inline‚Äë–∫–Ω–æ–ø–∫–∏
‚îú‚îÄ services/
‚îÇ  ‚îú‚îÄ db.py              # –¥–æ—Å—Ç—É–ø –∫ Postgres, upsert/queries, –≤–µ—Ä—Å–∏–∏ —Ñ–∞–∫—Ç–æ–≤, summary
‚îÇ  ‚îú‚îÄ geocode.py         # –≥–µ–æ–∫–æ–¥–∏–Ω–≥ –≥–æ—Ä–æ–¥–∞ ‚Üí (lat, lon, tz)
‚îÇ  ‚îú‚îÄ astro.py           # –ø–µ—Ä–µ–≤–æ–¥ –≤ UTC, –≤—ã–∑–æ–≤ –≤–Ω–µ—à–Ω–µ–≥–æ/–≤—Å—Ç—Ä–æ–µ–Ω–Ω–æ–≥–æ –∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä–∞
‚îÇ  ‚îú‚îÄ llm.py             # –≥–µ–Ω–µ—Ä–∞—Ü–∏—è —Ç–µ–∫—Å—Ç–æ–≤/—Å–ø–∏—Å–∫–æ–≤ (OpenAI), mock‚Äë—Ä–µ–∂–∏–º—ã
‚îú‚îÄ scenarios/
‚îÇ  ‚îî‚îÄ __init__.py        # enum SCN –∏ —Å–ª—É–∂–µ–±–Ω–æ–µ
‚îú‚îÄ web/                  # (–µ—Å–ª–∏ –ø–æ–¥–∫–ª—é—á–µ–Ω–æ) –ø—Ä–æ—Å—Ç–∞—è –∞–¥–º–∏–Ω–∫–∞/—Å—Ç—Ä–∞–Ω–∏—Ü—ã
‚îú‚îÄ docker-compose.yml
‚îú‚îÄ requirements.txt
‚îî‚îÄ README.md             # —ç—Ç–æ—Ç —Ñ–∞–π–ª
```

> –ö–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ –ø—É—Ç–∏/–∏–º–µ–Ω–∞ –º–æ–≥—É—Ç –æ—Ç–ª–∏—á–∞—Ç—å—Å—è; —Å–º–æ—Ç—Ä–∏ —Å–≤–æ–π —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π.

---

## ‚öôÔ∏è –ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç

### 1) .env (—Å–æ–∑–¥–∞—Ç—å —Ä—è–¥–æ–º —Å `docker-compose.yml`)

> **–ù–µ –ø—É–±–ª–∏–∫—É–π—Ç–µ —Ä–µ–∞–ª—å–Ω—ã–µ –∫–ª—é—á–∏!** –ü—Ä–∏–º–µ—Ä –Ω–∏–∂–µ ‚Äî —à–∞–±–ª–æ–Ω, –∑–∞–º–µ–Ω–∏—Ç–µ –Ω–∞ —Å–≤–æ–∏ –∑–Ω–∞—á–µ–Ω–∏—è.

```dotenv
# Telegram
BOT_OWNER_ID=805687695
BOT_TOKEN=<PUT_NEW_TELEGRAM_BOT_TOKEN_HERE>

# DB
POSTGRES_USER=app
POSTGRES_PASSWORD=app
POSTGRES_DB=appdb
DATABASE_URL=postgresql://app:app@db:5432/appdb

# OpenAI
OPENAI_API_KEY=<PUT_NEW_OPENAI_KEY_HERE>
OPENAI_MODEL=gpt-4o-mini
OPENAI_TEMPERATURE=0.2
OPENAI_TOP_P=1.0

# –ü—Ä–æ—á–µ–µ
SPINNER_STICKER_ID=5361837567463399422
SPINNER_REFRESH_SEC=4.5
LOG_LEVEL=INFO
TZ=Europe/Moscow
```

–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏:
- **–Ω–∏–∫–æ–≥–¥–∞** –Ω–µ –¥–æ–±–∞–≤–ª—è–π—Ç–µ `.env` –≤ git (`.gitignore`).
- `TZ` –≤–ª–∏—è–µ—Ç –Ω–∞ –ª–æ–≥–∏/–≤—Ä–µ–º—è –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é (–Ω–∞ —Ä–∞—Å—á—ë—Ç—ã –∫–∞—Ä—Ç—ã –Ω–µ –≤–ª–∏—è–µ—Ç, —Ç–∞–º –±–µ—Ä—ë—Ç—Å—è tz –∏–∑ –≥–µ–æ–∫–æ–¥–∏–Ω–≥–∞).

### 2) –ó–∞–ø—É—Å–∫ –≤ Docker

```bash
docker compose up --build -d
docker compose logs -f bot
```

> –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ `docker-compose.yml` –ø—Ä–æ–±—Ä–∞—Å—ã–≤–∞–µ—Ç –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è –∏–∑ `.env` –≤ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –±–æ—Ç–∞/–≤–µ–±‚Äë—Å–µ—Ä–≤–∏—Å–∞.

### 3) –õ–æ–∫–∞–ª—å–Ω—ã–π –∑–∞–ø—É—Å–∫ (–±–µ–∑ Docker)

```bash
python -m venv .venv
source .venv/bin/activate  # Windows: .venv\Scripts\activate
pip install -r requirements.txt

export $(cat .env | xargs)  # Windows: set –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ —Ä—É–∫–∞–º–∏ –∏–ª–∏ —á–µ—Ä–µ–∑ dotenv
python -m bot
```

---

## üóÑÔ∏è –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö

–ú–∏–Ω–∏–º–∞–ª—å–Ω–æ –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è —Ç–∞–±–ª–∏—Ü—ã (–Ω–∞–∑–≤–∞–Ω–∏—è/—Å—Ö–µ–º–∞ –º–æ–≥—É—Ç –æ—Ç–ª–∏—á–∞—Ç—å—Å—è –≤ –≤–∞—à–µ–º –ø—Ä–æ–µ–∫—Ç–µ):
- `users (id, tg_id, user_name, gender, ...)`
- `sessions (id, user_id, system, raw_calc_json, is_active, ...)`
- `session_facts (session_id, mission, love, countries, business, strengths, weaknesses, extra jsonb, ...)`
- `session_summary (session_id, summary_text)`
- `admin_settings (id=1, key/value –ø–æ–ª—è)` ‚Äî –≥–ª–æ–±–∞–ª—å–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
- `admin_scenarios (scenario, title, enabled, ...)` ‚Äî –≤–∫–ª—é—á—ë–Ω–Ω—ã–µ —Å—Ü–µ–Ω–∞—Ä–∏–∏ –≤ –º–µ–Ω—é
- `referrals (inviter_user_id, invited_user_id, created_at)`

> –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å—Ö–µ–º—ã –º–æ–∂–µ—Ç –≤—ã–ø–æ–ª–Ω—è—Ç—å—Å—è —á–µ—Ä–µ–∑ —Å–∫—Ä–∏–ø—Ç—ã –∏–ª–∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤ `services.db`. –ï—Å–ª–∏ —É –≤–∞—Å –µ—Å—Ç—å –º–∏–≥—Ä–∞—Ü–∏–∏ ‚Äî –ø—Ä–∏–º–µ–Ω–∏—Ç–µ –∏—Ö –ø–µ—Ä–µ–¥ –∑–∞–ø—É—Å–∫–æ–º.

### –ü–æ–ª–µ–∑–Ω—ã–µ SQL‚Äë—à–ø–∞—Ä–≥–∞–ª–∫–∏ (—á–µ—Ä–µ–∑ docker)

```bash
docker compose exec db psql -U app -d appdb -c "\dt"
docker compose exec db psql -U app -d appdb -c "SELECT COUNT(*) FROM users;"
```

–û—á–∏—Å—Ç–∏—Ç—å/–ø–æ—á–∏–Ω–∏—Ç—å –∫—ç—à –≥–æ–¥–æ–≤–æ–≥–æ –æ—Ç—á—ë—Ç–∞:
```sql
-- —É–¥–∞–ª–∏—Ç—å –∫–ª—é—á year –∏–∑ extra
UPDATE session_facts SET extra = COALESCE(extra,'{}'::jsonb) - 'year'
WHERE session_id = <SID>;
```

---

## üîê Growth‚Äë–º–µ—Ö–∞–Ω–∏–∫–∏ –∏ –∞–¥–º–∏–Ω‚Äë–Ω–∞—Å—Ç—Ä–æ–π–∫–∏

–í—Å–µ —Ñ–ª–∞–≥–∏ —á–∏—Ç–∞—é—Ç—Å—è –∏–∑ `admin_settings`. –ù–∞—Å—Ç—Ä–æ–∏—Ç—å –º–æ–∂–Ω–æ —á–µ—Ä–µ–∑ –≤–∞—à—É –≤–µ–±‚Äë–∞–¥–º–∏–Ω–∫—É –∏–ª–∏ via SQL.

### 1) –†–µ—Ñ–µ—Ä–∞–ª–∫–∞

–ö–ª—é—á–∏:
- `enable_referrals` ‚Äî `true/false` (–≤–∫–ª/–≤—ã–∫–ª —Å–∏—Å—Ç–µ–º—É)
- `referral_bonus_threshold` ‚Äî –ø–æ—Ä–æ–≥ –ø—Ä–∏–≥–ª–∞—à—ë–Ω–Ω—ã—Ö (–Ω–∞–ø—Ä–∏–º–µ—Ä `3`)

–†–µ—Ñ‚Äë—Å—Å—ã–ª–∫–∞ —Ñ–æ—Ä–º–∏—Ä—É–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∫–∞–∫:
```
https://t.me/<bot_username>?start=ref<tg_id>
```

### 2) –ì–µ–π—Ç—ã —Ä–∞–∑–¥–µ–ª–æ–≤

–ì–ª–∞–≤–Ω—ã–π –∫–ª—é—á ‚Äî `bonus_sections` (JSON). –ü—Ä–∏–º–µ—Ä:
```json
{
  "love": "referral",
  "finance": "channel",
  "countries": "channel"
}
```
–î–æ–ø—É—Å—Ç–∏–º—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è:  
- `"referral"` ‚Äî —Ä–∞–∑–¥–µ–ª –æ—Ç–∫—Ä–æ–µ—Ç—Å—è –ø–æ—Å–ª–µ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è –ø–æ—Ä–æ–≥–∞ –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏–π.  
- `"channel"` ‚Äî —Ä–∞–∑–¥–µ–ª –æ—Ç–∫—Ä–æ–µ—Ç—Å—è –ø–æ—Å–ª–µ –ø–æ–¥–ø–∏—Å–∫–∏ –Ω–∞ –∫–∞–Ω–∞–ª.

–î–ª—è `channel` —Ç–∞–∫–∂–µ –Ω—É–∂–Ω—ã –∫–ª—é—á–∏:
- `enable_channel_gate = true`
- `telegram_channel_id` ‚Äî –Ω–∞–ø—Ä–∏–º–µ—Ä `"@my_channel"` –∏–ª–∏ `-1001234567890`
- `telegram_channel_url` ‚Äî (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ) —è–≤–Ω–∞—è —Å—Å—ã–ª–∫–∞, –µ—Å–ª–∏ –Ω–µ—Ç username

> –ö–Ω–æ–ø–∫–∞ ¬´‚úÖ –Ø –ø–æ–¥–ø–∏—Å–∞–ª—Å—è¬ª —Ä–∞–±–æ—Ç–∞–µ—Ç **—É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–æ**: `callback_data="gate:recheck:<scenario>"`. –•–µ–Ω–¥–ª–µ—Ä –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤–µ—Ä–Ω—ë—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ –Ω—É–∂–Ω—ã–π —Ä–∞–∑–¥–µ–ª, –µ—Å–ª–∏ –ø–æ–¥–ø–∏—Å–∫–∞ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∞.

### 3) –ö–∞–∫–∏–µ —Ä–∞–∑–¥–µ–ª—ã –º–æ–∂–Ω–æ –∑–∞–∫—Ä—ã–≤–∞—Ç—å?

–õ—é–±—ã–µ –∏–∑: `mission`, `love`, `business`, `finance`, `countries`, `karma`, `year`.  
–í—ã –ø—Ä–æ—Å—Ç–æ –¥–æ–±–∞–≤–ª—è–µ—Ç–µ –Ω—É–∂–Ω—É—é –ø–∞—Ä—É –≤ `bonus_sections`.

---

## ü§ñ –°—Ü–µ–Ω–∞—Ä–∏–∏ –∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏—è

- –î–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è —Å—Ü–µ–Ω–∞—Ä–∏–µ–≤ –≤ –º–µ–Ω—é –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Ç–∞–±–ª–∏—Ü–∞ `admin_scenarios` (`list_enabled_scenarios()`).
- –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç —á–µ—Ä–µ–∑ `services.llm`:
  - –¢–µ–∫—Å—Ç—ã: `generate_text_or_mock(...)` (`mission`, `love`, `finance`, `karma`, `year`)
  - –°–ø–∏—Å–∫–∏: `generate_list_or_mock(...)` (`strengths`, `weaknesses`, `business`, `countries`)
  - –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π –ø—É—Ç—å: `run_scenario(session_id, code)` ‚Äî –≤–µ—Ä–Ω—ë—Ç `dict` (–∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤ —Ä–µ–≥–µ–Ω–µ/–∫–∞—Å—Ç–æ–º–Ω—ã—Ö).
- –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ:
  - `mission`, `love` ‚Üí –ø–æ–ª—è –≤ `session_facts` (—Å—Ç—Ä–æ–∫–∞)
  - `finance`, `karma`, `year` ‚Üí `session_facts.extra[code]` (—Å—Ç—Ä–æ–∫–∞)
  - —Å–ø–∏—Å–∫–∏ (`strengths`, `weaknesses`, `business`, `countries`) ‚Üí `{"items":[...]}`
  - –ø—Ä–æ—á–µ–µ/–∫–∞—Å—Ç–æ–º ‚Üí –∫–∞–∫ –µ—Å—Ç—å –≤ `extra[code]`
- –î–ª—è –∏—Å—Ç–æ—Ä–∏–∏ –∏ ¬´–ø–µ—Ä–µ–≥–µ–Ω–µ—Ä–∞—Ü–∏–∏¬ª –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è `add_fact_version(...)` + `rebuild_session_summary(...)`.

---

## üß≠ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–π —Å—Ü–µ–Ω–∞—Ä–∏–π (flow)

1. `/start` ‚Äî –±–æ—Ç —Å–æ–∑–¥–∞—ë—Ç/–Ω–∞—Ö–æ–¥–∏—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è, –ø—Ä–∏–≤—è–∑—ã–≤–∞–µ—Ç —Ä–µ—Ñ–µ—Ä–∞–ª–∫—É (–µ—Å–ª–∏ –±—ã–ª–∞).
2. –ò–º—è ‚Üí –ü–æ–ª ‚Üí –°–∏—Å—Ç–µ–º–∞ ‚Üí –î–∞—Ç–∞ ‚Üí –í—Ä–µ–º—è/¬´–Ω–µ –∑–Ω–∞—é¬ª ‚Üí –ì–æ—Ä–æ–¥.
3. –ì–µ–æ–∫–æ–¥–∏–Ω–≥ –∏ —Ä–∞—Å—á—ë—Ç –∫–∞—Ä—Ç—ã ‚Üí –≥–µ–Ω–µ—Ä–∞—Ü–∏—è **10/10** ‚Üí –ø–æ–∫–∞–∑ –≥–ª–∞–≤–Ω–æ–≥–æ –º–µ–Ω—é.
4. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤—ã–±–∏—Ä–∞–µ—Ç —Ä–∞–∑–¥–µ–ª—ã. –ï—Å–ª–∏ —Ä–∞–∑–¥–µ–ª ¬´–∑–∞–∫—Ä—ã—Ç¬ª, –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è —ç–∫—Ä–∞–Ω –≥–µ–π—Ç–∞:
   - `channel` ‚Äî –ø—Ä–µ–¥–ª–æ–∂–∏—Ç –ø–æ–¥–ø–∏—Å–∞—Ç—å—Å—è –∏ –Ω–∞–∂–∞—Ç—å ¬´‚úÖ –Ø –ø–æ–¥–ø–∏—Å–∞–ª—Å—è¬ª.
   - `referral` ‚Äî –æ—Ç–ø—Ä–∞–≤–∏—Ç –≤ ¬´–ü—Ä–∏–≥–ª–∞—Å–∏ –¥—Ä—É–≥–∞ ‚Üí –±–æ–Ω—É—Å¬ª —Å –ø—Ä–æ–≥—Ä–µ—Å—Å–æ–º.
5. –õ—é–±–æ–π —Ä–∞–∑–¥–µ–ª –º–æ–∂–Ω–æ ¬´‚ôªÔ∏è –ü–µ—Ä–µ—Å—á–∏—Ç–∞—Ç—å¬ª (–∫–Ω–æ–ø–∫–∞ –≤–Ω—É—Ç—Ä–∏ —Å—Ü–µ–Ω–∞—Ä–∏—è). –†–∞–±–æ—Ç–∞–µ—Ç —Å –≥–µ–π—Ç–∞–º–∏.

---

## üß™ –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏ –æ—Ç–ª–∞–¥–∫–∞

- **–ì–µ–π—Ç—ã –Ω–µ –æ—Ç–∫—Ä—ã–≤–∞—é—Ç—Å—è –ø–æ—Å–ª–µ –ø–æ–¥–ø–∏—Å–∫–∏**  
  –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ `telegram_channel_id` –∫–æ—Ä—Ä–µ–∫—Ç–µ–Ω:  
  - `@username` ‚Äî –º–æ–∂–Ω–æ —Å—Ç—Ä–æ–∏—Ç—å —Å—Å—ã–ª–∫—É –∏ –ø—Ä–æ–≤–µ—Ä—è—Ç—å —á–ª–µ–Ω—Å—Ç–≤–æ.  
  - `-100...` (–ø—Ä–∏–≤–∞—Ç–Ω—ã–π –±–µ–∑ username) ‚Äî —Å—Å—ã–ª–∫—É –Ω–µ —Å—Ç—Ä–æ–∏–º, –Ω–æ —á–ª–µ–Ω—Å—Ç–≤–æ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è –ø–æ ID.  
  –ù–∞–∂–∏–º–∞–π—Ç–µ ¬´‚úÖ –Ø –ø–æ–¥–ø–∏—Å–∞–ª—Å—è¬ª. –ï—Å–ª–∏ –≤—Å—ë –µ—â—ë –∑–∞–∫—Ä—ã—Ç–æ ‚Äî –±–æ—Ç –Ω–µ –≤–∏–¥–∏—Ç –≤–∞—Å –≤ —É—á–∞—Å—Ç–Ω–∏–∫–∞—Ö (–ø—Ä–æ–≤–µ—Ä—å—Ç–µ –ø—Ä–∞–≤–∞ –±–æ—Ç–∞ –∏ –∑–∞–¥–µ—Ä–∂–∫—É Telegram).

- **–†–µ—Ñ–µ—Ä–∞–ª–∫–∞ –Ω–µ —Å—á–∏—Ç–∞–µ—Ç –ø—Ä–∏–≥–ª–∞—à—ë–Ω–Ω—ã—Ö**  
  –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ –ø—Ä–∏–≥–ª–∞—à—ë–Ω–Ω—ã–µ –∑–∞—Ö–æ–¥–∏–ª–∏ **–ø–æ –≤–∞—à–µ–π** —Å—Å—ã–ª–∫–µ, –∏ —á—Ç–æ `register_referral(...)` –Ω–µ –ø–∞–¥–∞–µ—Ç (—Å–º. –ª–æ–≥–∏).  
  –ü–æ—Ä–æ–≥ –±–µ—Ä—ë—Ç—Å—è –∏–∑ `referral_bonus_threshold`.

- **–í –≥–æ–¥–æ–≤–æ–º –æ—Ç—á—ë—Ç–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è `{"year": ...}`**  
  –í `handlers.py` –¥–æ–±–∞–≤–ª–µ–Ω–∞ –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è/—Ä–∞—Å–ø–∞–∫–æ–≤–∫–∞ –∏ –ø–µ—Ä–µ–∑–∞–ø–∏—Å—å –∫—ç—à–∞. –ï—Å–ª–∏ –≤–∏–¥–∏—Ç–µ —Å—Ç–∞—Ä–æ–µ –ø–æ–≤–µ–¥–µ–Ω–∏–µ ‚Äî –æ—á–∏—Å—Ç–∏—Ç–µ –∫–ª—é—á:
  ```sql
  UPDATE session_facts SET extra = coalesce(extra, '{}'::jsonb) - 'year' WHERE session_id=<SID>;
  ```
  –∏ –∑–∞–ø—Ä–æ—Å–∏—Ç–µ —Ä–∞–∑–¥–µ–ª –∑–∞–Ω–æ–≤–æ.

- **Aiogram: "message is not modified"**  
  –õ–æ–≤–∏—Ç—Å—è –∏ –ø–æ–¥–∞–≤–ª—è–µ—Ç—Å—è –≤ `safe_edit(...)`. –≠—Ç–æ –Ω–µ –æ—à–∏–±–∫–∞, –ø—Ä–æ—Å—Ç–æ Telegram –Ω–µ –º–µ–Ω—è–µ—Ç –∏–¥–µ–Ω—Ç–∏—á–Ω—ã–π —Ç–µ–∫—Å—Ç.

- **–ö–∞—Å—Ç–æ–º–Ω—ã–π —Å–ø–∏–Ω–Ω–µ—Ä**  
  –£–∫–∞–∂–∏—Ç–µ `SPINNER_STICKER_ID` (custom emoji id). –ï—Å–ª–∏ –Ω–µ—Ç ‚Äî –±–æ—Ç –ø–æ—à–ª—ë—Ç –æ–±—ã—á–Ω—ã–π üîÆ.

---

## üîí –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

- –†–µ–≤–æ–∫—É–π—Ç–µ –∏ **–Ω–∏–∫–æ–≥–¥–∞ –Ω–µ –ø—É–±–ª–∏–∫—É–π—Ç–µ** —Ä–µ–∞–ª—å–Ω—ã–µ `BOT_TOKEN` –∏ `OPENAI_API_KEY`.
- –î–æ–±–∞–≤—å—Ç–µ `.env` –≤ `.gitignore`.
- –û–≥—Ä–∞–Ω–∏—á—å—Ç–µ –¥–æ—Å—Ç—É–ø –∫ –ë–î –∏ –ª–æ–≥–∞–º.

---

## üõ†Ô∏è –ö–æ–º–∞–Ω–¥—ã —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–∞ (psql –ø–æ–¥ Docker)

```bash
# –ü–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ –ë–î
docker compose exec db psql -U app -d appdb

# –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –≤–∫–ª—é—á—ë–Ω–Ω—ã–µ —Å—Ü–µ–Ω–∞—Ä–∏–∏ –º–µ–Ω—é
SELECT scenario, title, enabled FROM admin_scenarios ORDER BY scenario;

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
SELECT * FROM admin_settings WHERE id=1;

# –ü–æ—Å—Ç–∞–≤–∏—Ç—å –≥–µ–π—Ç –¥–ª—è —Ä–∞–∑–¥–µ–ª–æ–≤ (–ø—Ä–∏–º–µ—Ä)
UPDATE admin_settings
SET bonus_sections = '{
  "love": "referral",
  "finance": "channel"
}';
```

---

## üôã FAQ

**–ö–∞–∫ —Å–¥–µ–ª–∞—Ç—å, —á—Ç–æ–±—ã –±–æ–Ω—É—Å–æ–º –ø–æ —Ä–µ—Ñ–µ—Ä–∞–ª–∫–µ –±—ã–ª –Ω–µ ¬´–ì–æ–¥–æ–≤–æ–π –æ—Ç—á—ë—Ç¬ª, –∞ ¬´–õ–∏—á–Ω–∞—è –∂–∏–∑–Ω—å¬ª?**  
–í `admin_settings.bonus_sections` –ø–æ—Å—Ç–∞–≤—å—Ç–µ:
```json
{"love": "referral"}
```
–∏ –≤–∫–ª—é—á–∏—Ç–µ `enable_referrals=true` —Å –Ω—É–∂–Ω—ã–º `referral_bonus_threshold`.

**–ö–∞–∫ –≤–∫–ª—é—á–∏—Ç—å –¥–æ—Å—Ç—É–ø –ø–æ –∫–∞–Ω–∞–ª—É –¥–ª—è –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö —Ä–∞–∑–¥–µ–ª–æ–≤?**  
```json
{"finance": "channel", "countries": "channel"}
```
–∞ —Ç–∞–∫–∂–µ `enable_channel_gate=true` –∏ –∑–∞–ø–æ–ª–Ω–∏—Ç–µ `telegram_channel_id`/`telegram_channel_url`.

**–ì–¥–µ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Ç–µ–∫—Å—Ç—ã/–∑–∞–≥–æ–ª–æ–≤–∫–∏ —Å—Ü–µ–Ω–∞—Ä–∏–µ–≤?**  
–í —Ç–∞–±–ª–∏—Ü–∞—Ö/–∞–¥–º–∏–Ω–∫–µ: `admin_scenarios` (–∑–∞–≥–æ–ª–æ–≤–∫–∏/–≤–∫–ª—é—á–µ–Ω–∏–µ), `admin_settings` (—Ç–µ–∫—Å—Ç—ã –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏—è, –ø—Ä–æ–º–ø—Ç—ã, –¥—Ä.).

---

## üß© –í–µ—Ä—Å–∏–∏ –∏ –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ

- –ö–∞–∂–¥–∞—è –≥–µ–Ω–µ—Ä–∞—Ü–∏—è –ø–∏—à–µ—Ç—Å—è –≤ –∏—Å—Ç–æ—Ä–∏—é (`add_fact_version`), –º–æ–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –æ—Ç–∫–∞—Ç–∞.
- –í `session_facts.extra` —Ç–µ–∫—Å—Ç–æ–≤—ã–µ —Å—Ü–µ–Ω–∞—Ä–∏–∏ –ª–µ–∂–∞—Ç ¬´–ø–ª–æ—Å–∫–∏–º–∏¬ª —Å—Ç—Ä–æ–∫–∞–º–∏, —Å–ø–∏—Å–æ—á–Ω—ã–µ ‚Äî –ø–æ–¥ `{"items":[...]}`.
- –î–ª—è –æ—á–∏—â–µ–Ω–∏—è –∫—ç—à–∞ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ —Å—Ü–µ–Ω–∞—Ä–∏—è –≤ `extra`:
  ```sql
  UPDATE session_facts SET extra = COALESCE(extra,'{}'::jsonb) - '<code>' WHERE session_id=<SID>;
  ```

---

## üìÑ –õ–∏—Ü–µ–Ω–∑–∏—è

–£–∫–∞–∂–∏—Ç–µ –ª–∏—Ü–µ–Ω–∑–∏—é –≤ –∫–æ—Ä–Ω–µ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è (–Ω–∞–ø—Ä–∏–º–µ—Ä, MIT) –∏–ª–∏ —É–¥–∞–ª–∏—Ç–µ —ç—Ç–æ—Ç —Ä–∞–∑–¥–µ–ª.
